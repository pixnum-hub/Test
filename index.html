<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva Weather</title>
<meta name="theme-color" content="#000000">

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,system-ui;
background:#000;
color:#fff;
text-align:center;
padding:20px;
}
.card{
background:#1a1a1a;
padding:20px;
border-radius:20px;
margin:15px 0;
}
button,input{
width:100%;
padding:14px;
margin:8px 0;
border-radius:20px;
border:none;
font-size:16px;
}
button{background:#333;color:#fff}
input{background:#222;color:#fff}
#temp{font-size:60px;margin:10px 0}
small{color:#aaa}
</style>
</head>

<body>

<h1>üå¶Ô∏è Rituva</h1>

<input id="search" placeholder="Search city"
onkeydown="if(event.key==='Enter')searchCity()">
<button onclick="searchCity()">Search</button>
<button onclick="useMyLocation()">üìç Use My Location</button>

<div class="card">
<small id="city">Loading...</small>
<div id="temp">--</div>
<small id="status">Connecting...</small>
</div>

<div class="card">
<small>AQI</small>
<div id="aqi">--</div>
<small id="aqiCat"></small>
</div>

<script>

const $ = id => document.getElementById(id);

function saveCache(data){
localStorage.setItem("weatherCache", JSON.stringify(data));
}

function loadCache(){
try{
return JSON.parse(localStorage.getItem("weatherCache"));
}catch{return null;}
}

function calculateAQI(pm){
if(pm<=12) return {v:Math.round(pm*4.16),cat:"Good",col:"#00E400"};
if(pm<=35.4) return {v:75,cat:"Moderate",col:"#FFFF00"};
if(pm<=55.4) return {v:125,cat:"Unhealthy (SG)",col:"#FF7E00"};
if(pm<=150) return {v:175,cat:"Unhealthy",col:"#FF0000"};
return {v:250,cat:"Very Unhealthy",col:"#8F3F97"};
}

function applyData({w,a}){

const temp = w.current?.temperature_2m;

if(temp===undefined){
$("status").innerText="Weather data unavailable";
return;
}

$("temp").innerText = temp.toFixed(1) + "¬∞C";
$("status").innerText="Live Data";

const pm = a.hourly?.pm2_5?.[0] || 0;
const aq = calculateAQI(pm);

$("aqi").innerText = aq.v;
$("aqi").style.color = aq.col;
$("aqiCat").innerText = aq.cat;
$("aqiCat").style.color = aq.col;
}

async function load(lat,lon,name){

if(!lat || !lon || lat===0 || lon===0){
$("city").innerText="Location Error";
$("status").innerText="Invalid coordinates";
return;
}

$("city").innerText=name;
$("status").innerText="Fetching live data...";

try{

const weatherURL =
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m&timezone=auto`;

const airURL =
`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5`;

const wRes = await fetch(weatherURL);
const aRes = await fetch(airURL);

if(!wRes.ok) throw new Error("Weather API failed");
if(!aRes.ok) throw new Error("Air API failed");

const w = await wRes.json();
const a = await aRes.json();

applyData({w,a});
saveCache({w,a});

}
catch(error){

console.error("Fetch error:", error);

const cached = loadCache();

if(cached){
$("status").innerText="Offline (Showing cached data)";
applyData(cached);
}else{
$("status").innerText="Offline ‚Äì Unable to connect";
$("temp").innerText="--";
}

}
}

function useMyLocation(){
navigator.geolocation.getCurrentPosition(
pos => load(pos.coords.latitude,pos.coords.longitude,"My Location"),
err => {
console.error("Geolocation error:", err);
load(22.57,88.36,"Kolkata");
}
);
}

async function searchCity(){
const city = $("search").value;
if(!city) return;

$("status").innerText="Searching...";

try{
const geoURL =
`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`;

const res = await fetch(geoURL);
const data = await res.json();

if(data.results){
const r = data.results[0];
load(r.latitude,r.longitude,r.name);
}else{
$("status").innerText="City not found";
}
}
catch(e){
console.error(e);
$("status").innerText="Search failed";
}
}

useMyLocation();

</script>

</body>
</html>
